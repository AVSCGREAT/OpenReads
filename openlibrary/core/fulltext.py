import json
import logging

import requests
import web
from infogami import config
from openlibrary.core.lending import get_availability_of_ocaids
from openlibrary.plugins.openlibrary.home import format_book_data
from urllib.parse import urlencode

logger = logging.getLogger("openlibrary.inside")


def fulltext_search_api(params):
    if not hasattr(config, 'plugin_inside'):
        return {'error': 'Unable to prepare search engine'}
    search_endpoint = config.plugin_inside['search_endpoint']
    search_select = search_endpoint + '?' + urlencode(params, 'utf-8')

    logger.debug('URL: ' + search_select)
    try:
        response = requests.get(search_select, timeout=30)
        response.raise_for_status()
        return response.json()
    except requests.HTTPError:
        return {'error': 'Unable to query search engine'}
    except json.decoder.JSONDecodeError:
        return {'error': 'Error converting search engine data to JSON'}


def fulltext_search(q, page=1, limit=100, js=False, facets=False):
    offset = (page - 1) * limit
    params = {
        'q': q,
        'from': offset,
        'size': limit,
        **({'nofacets': 'true'} if not facets else {}),
        'olonly': 'true',
    }
    ia_results = fulltext_search_api(params)
    if 'error' not in ia_results and ia_results['hits']:
        hits = ia_results['hits'].get('hits', [])
        ocaids = [hit['fields'].get('identifier', [''])[0] for hit in hits]
        # availability = get_availability_of_ocaids(ocaids)
        availability = {'cricketintimessq0000seld': {'status': 'private', 'available_to_browse': False, 'available_to_borrow': False, 'available_to_waitlist': False, 'is_printdisabled': True, 'is_readable': False, 'is_lendable': False, 'is_previewable': True, 'identifier': 'cricketintimessq0000seld', 'isbn': '0140301836', 'oclc': None, 'openlibrary_work': 'OL15136938W', 'openlibrary_edition': 'OL32090209M', 'last_loan_date': None, 'num_waitlist': None, 'last_waitlist_date': None, 'is_restricted': True, 'is_browseable': False, '__src__': 'core.models.lending.get_availability'}, 'cricketintimessq00thom': {'status': 'private', 'available_to_browse': False, 'available_to_borrow': False, 'available_to_waitlist': False, 'is_printdisabled': True, 'is_readable': False, 'is_lendable': False, 'is_previewable': True, 'identifier': 'cricketintimessq00thom', 'isbn': None, 'oclc': None, 'openlibrary_work': 'OL15400990W', 'openlibrary_edition': 'OL24375865M', 'last_loan_date': None, 'num_waitlist': None, 'last_waitlist_date': None, 'is_restricted': True, 'is_browseable': False, '__src__': 'core.models.lending.get_availability'}, 'cricketintimessq00seld': {'status': 'private', 'available_to_browse': False, 'available_to_borrow': False, 'available_to_waitlist': False, 'is_printdisabled': True, 'is_readable': False, 'is_lendable': False, 'is_previewable': True, 'identifier': 'cricketintimessq00seld', 'isbn': None, 'oclc': None, 'openlibrary_work': 'OL15136938W', 'openlibrary_edition': 'OL24204364M', 'last_loan_date': None, 'num_waitlist': None, 'last_waitlist_date': None, 'is_restricted': True, 'is_browseable': False, '__src__': 'core.models.lending.get_availability'}, 'cricketintimes00geor': {'status': 'private', 'available_to_browse': False, 'available_to_borrow': False, 'available_to_waitlist': False, 'is_printdisabled': True, 'is_readable': False, 'is_lendable': False, 'is_previewable': True, 'identifier': 'cricketintimes00geor', 'isbn': '0440715636', 'oclc': None, 'openlibrary_work': 'OL8125719W', 'openlibrary_edition': 'OL7522718M', 'last_loan_date': None, 'num_waitlist': None, 'last_waitlist_date': None, 'is_restricted': True, 'is_browseable': False, '__src__': 'core.models.lending.get_availability'}, 'cricketintimessq0000seld_j8o3': {'status': 'private', 'available_to_browse': False, 'available_to_borrow': False, 'available_to_waitlist': False, 'is_printdisabled': True, 'is_readable': False, 'is_lendable': False, 'is_previewable': True, 'identifier': 'cricketintimessq0000seld_j8o3', 'isbn': '0312380038', 'oclc': None, 'openlibrary_work': 'OL4111010W', 'openlibrary_edition': 'OL10389352M', 'last_loan_date': None, 'num_waitlist': None, 'last_waitlist_date': None, 'is_restricted': True, 'is_browseable': False, '__src__': 'core.models.lending.get_availability'}, 'cricketintimessq00seld_0': {'status': 'private', 'available_to_browse': False, 'available_to_borrow': False, 'available_to_waitlist': False, 'is_printdisabled': True, 'is_readable': False, 'is_lendable': False, 'is_previewable': True, 'identifier': 'cricketintimessq00seld_0', 'isbn': '9780374316501', 'oclc': None, 'openlibrary_work': 'OL4111022W', 'openlibrary_edition': 'OL21463417M', 'last_loan_date': '2020-09-08T14:55:59Z', 'num_waitlist': '0', 'last_waitlist_date': '2020-08-30T07:43:40Z', 'is_restricted': True, 'is_browseable': False, '__src__': 'core.models.lending.get_availability'}, 'cricketintime00seld': {'status': 'private', 'available_to_browse': False, 'available_to_borrow': False, 'available_to_waitlist': False, 'is_printdisabled': True, 'is_readable': False, 'is_lendable': False, 'is_previewable': True, 'identifier': 'cricketintime00seld', 'isbn': '0440415632', 'oclc': None, 'openlibrary_work': 'OL16036066W', 'openlibrary_edition': 'OL24937942M', 'last_loan_date': '2020-09-04T17:49:15Z', 'num_waitlist': '0', 'last_waitlist_date': '2020-07-13T23:25:52Z', 'is_restricted': True, 'is_browseable': False, '__src__': 'core.models.lending.get_availability'}, 'cricketintimessq0000seld_a5b6': {'status': 'private', 'available_to_browse': False, 'available_to_borrow': False, 'available_to_waitlist': False, 'is_printdisabled': True, 'is_readable': False, 'is_lendable': False, 'is_previewable': True, 'identifier': 'cricketintimessq0000seld_a5b6', 'isbn': '0440415632', 'oclc': None, 'openlibrary_work': 'OL4111022W', 'openlibrary_edition': 'OL17434687M', 'last_loan_date': None, 'num_waitlist': None, 'last_waitlist_date': None, 'is_restricted': True, 'is_browseable': False, '__src__': 'core.models.lending.get_availability'}, 'cricketintimessq0000seld_i1z0': {'status': 'private', 'available_to_browse': False, 'available_to_borrow': False, 'available_to_waitlist': False, 'is_printdisabled': True, 'is_readable': False, 'is_lendable': False, 'is_previewable': True, 'identifier': 'cricketintimessq0000seld_i1z0', 'isbn': '046002759X', 'oclc': None, 'openlibrary_work': 'OL15136938W', 'openlibrary_edition': 'OL32090210M', 'last_loan_date': None, 'num_waitlist': None, 'last_waitlist_date': None, 'is_restricted': True, 'is_browseable': False, '__src__': 'core.models.lending.get_availability'}, 'isbn_9781780331232': {'status': 'borrow_available', 'available_to_browse': True, 'available_to_borrow': False, 'available_to_waitlist': False, 'is_printdisabled': True, 'is_readable': False, 'is_lendable': True, 'is_previewable': True, 'identifier': 'isbn_9781780331232', 'isbn': '9781780339061', 'oclc': None, 'openlibrary_work': 'OL17413435W', 'openlibrary_edition': 'OL25995305M', 'last_loan_date': None, 'num_waitlist': None, 'last_waitlist_date': None, 'is_restricted': True, 'is_browseable': True, '__src__': 'core.models.lending.get_availability'}, 'fieldofshadows0000wadd': {'status': 'borrow_available', 'available_to_browse': True, 'available_to_borrow': False, 'available_to_waitlist': False, 'is_printdisabled': True, 'is_readable': False, 'is_lendable': True, 'is_previewable': True, 'identifier': 'fieldofshadows0000wadd', 'isbn': '9780593072615', 'oclc': None, 'openlibrary_work': 'OL21094714W', 'openlibrary_edition': 'OL35333008M', 'last_loan_date': None, 'num_waitlist': None, 'last_waitlist_date': None, 'is_restricted': True, 'is_browseable': True, '__src__': 'core.models.lending.get_availability'}, 'sloggingslavspar0000bell': {'status': 'borrow_available', 'available_to_browse': True, 'available_to_borrow': False, 'available_to_waitlist': False, 'is_printdisabled': True, 'is_readable': False, 'is_lendable': True, 'is_previewable': True, 'identifier': 'sloggingslavspar0000bell', 'isbn': '0955433207', 'oclc': None, 'openlibrary_work': 'OL24851412W', 'openlibrary_edition': 'OL33031114M', 'last_loan_date': None, 'num_waitlist': None, 'last_waitlist_date': None, 'is_restricted': True, 'is_browseable': True, '__src__': 'core.models.lending.get_availability'}, 'caughtincourtsel0000scot': {'status': 'borrow_available', 'available_to_browse': True, 'available_to_borrow': False, 'available_to_waitlist': False, 'is_printdisabled': True, 'is_readable': False, 'is_lendable': True, 'is_previewable': True, 'identifier': 'caughtincourtsel0000scot', 'isbn': '0233984798', 'oclc': None, 'openlibrary_work': 'OL759678W', 'openlibrary_edition': 'OL10197946M', 'last_loan_date': None, 'num_waitlist': None, 'last_waitlist_date': None, 'is_restricted': True, 'is_browseable': True, '__src__': 'core.models.lending.get_availability'}, 'battingonbosphor0000bell': {'status': 'borrow_available', 'available_to_browse': True, 'available_to_borrow': False, 'available_to_waitlist': False, 'is_printdisabled': True, 'is_readable': False, 'is_lendable': True, 'is_previewable': True, 'identifier': 'battingonbosphor0000bell', 'isbn': '9781926812007', 'oclc': None, 'openlibrary_work': 'OL17537914W', 'openlibrary_edition': 'OL26127661M', 'last_loan_date': None, 'num_waitlist': None, 'last_waitlist_date': None, 'is_restricted': True, 'is_browseable': True, '__src__': 'core.models.lending.get_availability'}, 'battinginbaltic10000bell': {'status': 'borrow_available', 'available_to_browse': True, 'available_to_borrow': False, 'available_to_waitlist': False, 'is_printdisabled': True, 'is_readable': False, 'is_lendable': True, 'is_previewable': True, 'identifier': 'battinginbaltic10000bell', 'isbn': '9780143024224', 'oclc': None, 'openlibrary_work': 'OL28590891W', 'openlibrary_edition': 'OL39200969M', 'last_loan_date': None, 'num_waitlist': None, 'last_waitlist_date': None, 'is_restricted': True, 'is_browseable': True, '__src__': 'core.models.lending.get_availability'}, 'battingonbosphor0000bell_w5e6': {'status': 'borrow_available', 'available_to_browse': True, 'available_to_borrow': False, 'available_to_waitlist': False, 'is_printdisabled': True, 'is_readable': False, 'is_lendable': True, 'is_previewable': True, 'identifier': 'battingonbosphor0000bell_w5e6', 'isbn': '9781847672902', 'oclc': None, 'openlibrary_work': 'OL17536282W', 'openlibrary_edition': 'OL26125971M', 'last_loan_date': None, 'num_waitlist': None, 'last_waitlist_date': None, 'is_restricted': True, 'is_browseable': True, '__src__': 'core.models.lending.get_availability'}, 'beyondfarpavilio0000unse': {'status': 'borrow_available', 'available_to_browse': True, 'available_to_borrow': False, 'available_to_waitlist': False, 'is_printdisabled': True, 'is_readable': False, 'is_lendable': True, 'is_previewable': True, 'identifier': 'beyondfarpavilio0000unse', 'isbn': '0099494108', 'oclc': None, 'openlibrary_work': 'OL19030435W', 'openlibrary_edition': 'OL17316354M', 'last_loan_date': None, 'num_waitlist': None, 'last_waitlist_date': None, 'is_restricted': True, 'is_browseable': True, '__src__': 'core.models.lending.get_availability'}, 'cricketonairsele0000unse': {'status': 'borrow_available', 'available_to_browse': True, 'available_to_borrow': False, 'available_to_waitlist': False, 'is_printdisabled': True, 'is_readable': False, 'is_lendable': True, 'is_previewable': True, 'identifier': 'cricketonairsele0000unse', 'isbn': '0563203439', 'oclc': None, 'openlibrary_work': 'OL8400585W', 'openlibrary_edition': 'OL17062964M', 'last_loan_date': None, 'num_waitlist': None, 'last_waitlist_date': None, 'is_restricted': True, 'is_browseable': True, '__src__': 'core.models.lending.get_availability'}, 'parachutistatfin0000unse': {'status': 'borrow_available', 'available_to_browse': True, 'available_to_borrow': False, 'available_to_waitlist': False, 'is_printdisabled': True, 'is_readable': False, 'is_lendable': True, 'is_previewable': True, 'identifier': 'parachutistatfin0000unse', 'isbn': '9781845132569', 'oclc': None, 'openlibrary_work': 'OL17583672W', 'openlibrary_edition': 'OL26186839M', 'last_loan_date': None, 'num_waitlist': None, 'last_waitlist_date': None, 'is_restricted': True, 'is_browseable': True, '__src__': 'core.models.lending.get_availability'}, 'benaudonreflecti0000bena': {'status': 'borrow_available', 'available_to_browse': True, 'available_to_borrow': False, 'available_to_waitlist': False, 'is_printdisabled': True, 'is_readable': False, 'is_lendable': True, 'is_previewable': True, 'identifier': 'benaudonreflecti0000bena', 'isbn': '0002180340', 'oclc': None, 'openlibrary_work': 'OL2232494W', 'openlibrary_edition': 'OL17373735M', 'last_loan_date': None, 'num_waitlist': None, 'last_waitlist_date': None, 'is_restricted': True, 'is_browseable': True, '__src__': 'core.models.lending.get_availability'}}
        if 'error' in availability:
            return []
        editions = web.ctx.site.get_many(
            [
                '/books/%s' % availability[ocaid].get('openlibrary_edition')
                for ocaid in availability
                if availability[ocaid].get('openlibrary_edition')
            ]
        )
        for ed in editions:
            if ed.ocaid in ocaids:
                idx = ocaids.index(ed.ocaid)
                ia_results['hits']['hits'][idx]['edition'] = (
                    format_book_data(ed, fetch_availability=False) if js else ed
                )
                ia_results['hits']['hits'][idx]['availability'] = availability[ed.ocaid]
    return ia_results
