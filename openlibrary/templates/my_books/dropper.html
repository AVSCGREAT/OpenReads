$def with(page, async_load=False)

$code:
  '''
  To start, this should get all of the parameters that the lists/widget gets.
  In general:
    1. We must determine if there is a work.  If not, the dropper only contains lists.
    2. Is the patron logged in?  If not, clicking dropper should redirect to login page.
       Dropdown doesn't need to be rendered in this situation.
    3. Ensure that forms contain all the data necessary for a submission (lists and reading log)
  '''
$ edition = page if page.key.startswith("/books/") else None
$ edition_key = edition and edition.key
$ work = (page.works and page.works[0]) if edition else page if page.key.startswith("/works/") else None
$ work_key = work and work.key

$ user_key = ctx.user and ctx.user.key
$ username = user_key and user_key.split('/')[-1]

$# XXX: Find more performant way to get read statuses
$# XXX: Read status values and their meanings should probably be here in a comment
$ users_work_read_status = work.get_users_read_status(username) if work and username else None

$ seed_info = get_seed_info(page)
$# user_lists = [] if async_load or not ctx.user else get_user_lists(seed_info)
$ user_lists = [] if not ctx.user else get_user_lists(seed_info)
$# XXX: Not used here
$ page_lists = [get_list_data(list, seed_info['seed']) for list in page.get_lists(sort=False)]
$ page_url = page.url()

$# XXX: Else condition is for subjects, which can be removed
$ seed_key = seed_info['seed']['key']

$ show_list_i18n_strings = {
  $ "cover_of": _('Cover of: %(title)s', title=''),
  $ "see_this_list": _('See this list'),
  $ "remove_from_list": _('Remove from your list?'),
  $ "from": _('from'),
  $ "you": _('You')
  $ }

$ primary_action = render_template('my_books/primary_action', work_key, edition_key, user_key, users_work_read_status, page_url)
$ dropdown_content = render_template('my_books/dropdown_content', user_lists, seed_key, work_key, edition_key, users_work_read_status, async_load=async_load)
$:render_template('lib/dropper', primary_action, dropdown_content)
