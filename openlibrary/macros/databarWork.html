$def with (page, editions_page=False, render_times={})

$ is_privileged_user = ctx.user and (ctx.user.is_admin() or ctx.user.is_librarian())
$ is_librarian = ctx.user and ctx.user.is_librarian()

$ component_times = {}
$ component_times['TotalTime'] = time()

$ tab = input(tab=None).tab
$ editions = []
$ page_type = page.key.split('/')[1]
$ show_observations = True

$if page.key.startswith('/works'):
  $ work = page
$elif page.works:
  $ work = list(page.works)[0]
$else:
  $ work = page.make_work_from_orphaned_edition()
  $ show_observations = False

$ edition = storage({})
$if page.key.startswith('/books'):
  $# We are on an editions page: an edition has been explicitly selected
  $ edition = page

$ selected_provider = None
$ selected_id = None
$ provider = None
$if query_param('edition'):
  $if ':' in query_param('edition'):
    $ [selected_provider, selected_id] = query_param('edition').split(':')
  $else:
    $ [selected_provider, selected_id] = ['ia', query_param('edition')]
  $ provider = get_book_provider_by_name(selected_provider)

$ component_times['get_sorted_editions'] = time()

$# Fetch a work's editions
$# Used for loading the editions table
$# Book availability of editions injected by bulk get_availability API
$ edition_count = work.edition_count if work and work.edition_count else 1
$ ebooks_only = (query_param('mode') == 'ebooks') or (query_param('mode') != 'all' and edition_count > 10)

$# For performance reasons, limit to 10 ebooks
$# Tradeoff: limits our ability to select best edition
$ editions_limit = None if query_param('mode') in ['all', 'ebooks'] else 10
$# key ensures the current edition we're on or requested edition are fetched by get_sorted_editions
$ keys = (edition and [edition.key]) or (provider and provider.get_olids(selected_id))
$if ebooks_only:
  $ editions = work.get_sorted_editions(ebooks_only=ebooks_only, limit=editions_limit, keys=keys)
$if not editions:
  $# use ebooks_only to determine whether to lazyload editions table
  $ ebooks_only = False
  $ editions = work.get_sorted_editions(limit=editions_limit, keys=keys)
$ availabilities = {e.availability.get('identifier'): e.availability for e in editions}
$ component_times['get_sorted_editions'] = time() - component_times['get_sorted_editions']

$# This collects which books are previewable in any manner
$ previews = [e for e in editions if e.get('ocaid')]

$# Choose an edition to render
$if editions and not edition:
  $# We're presumably on a work url
  $# edition selection strategy (e.g. language, by id, first w/ ocaid)
  $if provider:
    $ edition = next((e for e in editions if selected_id in provider.get_identifiers(e)), editions[0])
  $else:
    $ edition, provider = get_best_edition(editions)

$# Just in case edition is not set, treat as work
$ edition = edition or page
$ is_editionless_work = edition.type != '/type/edition'

$if not edition.get('availability'):
  $ edition['availability'] = edition.get('ocaid') and availabilities.get(edition['ocaid']) or {}
$ ocaid = edition.get('ocaid')
$ book_title = edition.get('title', '') or (work.title if work else '')
$ work_title = work.title if work else edition.get('title', '')
$ book_subtitle = edition.get('subtitle', '')
$ title_suffix = cond(edition.get('publish_date'), u"({0} edition)".format(edition.get('publish_date')), "(edition)")
$ title = book_title + " " + title_suffix
$ title_with_site = _("%(page_title)s | Open Library", page_title=title)
$ meta_cover_url = item_image((edition or work).get_cover_url("L"), default="https://openlibrary.org/images/icons/avatar_book-sm.png")
$ _x = ctx.setdefault('cssfile', 'book')

$var title: $title

$code:
    def has_any(*keys):
        return any(edition[k] for k in keys)

$code:
    def get_description(book):
        if book.publishers and book.publish_date:
            ed_info = book.publish_date + ', ' + ', '.join(book.publishers)
        elif book.publish_date:
            ed_info = book.publish_date
        elif book.publishers:
            ed_info = ', '.join(book.publishers)
        else:
            ed_info = 'unknown'

        title = cond(work, work.title, book.title)
        authors = cond(work, work and work.get_authors(), book.get_authors())
        author_info = " by " + ", ".join(a.name or "Unknown author" for a in authors)

        format = ""
        if book.physical_format:
            format += book.physical_format.replace('[', '').replace(']', '')

        if book.languages:
            format += ' in ' + ', '.join(lang.name for lang in book.languages)
        if book.edition_name:
            format += " - " + book.edition_name

        meta = title + author_info + ", " + ed_info + " edition, " + format
        return meta
    description = get_description(page)
    putctx("description", description)

$def display_value(label, value, itemprop=None):
    $if value:
        <dt>$label</dt>
        $if itemprop:
            <dd itemprop="$itemprop" class="object">$:thingrepr(value)</dd>
        $else:
            <dd class="object">$:thingrepr(value)</dd>

$def display_identifiers(label, ids, itemprop=None):
    $if label != "Goodreads":
        $ all_ids = [-1!=id['value'].find('openlib-') for id in ids]
        $if (True in all_ids) and (1==len(all_ids)):
            $return

        <!-- FIXME: Identifier names need to be translated (I18N) -->
        <dt>$label</dt>
        <dd class="object" $:cond(itemprop, 'itemprop="%s"' % itemprop, '')>
            $for id in ids:
                $ sep = cond(loop.last, "", ", ")
                $if -1 != id.value.find('openlib-'):
                    $continue
                $if id.url:
                    <a href="$id.url$('?tag=' + affiliate_id('amazon') if 'amazon.' in id.url else '')">$id.value</a>$sep
                $else:
                    ${id.value}$sep
        </dd>

$def display_goodreads(label, ids):
    $if label == "Goodreads":
        <dt>$label</dt>
        $for id in ids:
            <dd><a href="$id.url">$id.value</a></dd>

$:macros.Metatags(title=title_with_site, image=meta_cover_url, description=description)
$set_share_links(url=request.canonical_url, title=title, view_context=ctx)

$if is_privileged_user:
  $:render_template("type/edition/admin_bar", work, edition, ocaid)




$if page.type.key == '/type/work' and page.edition_count == 1:
    $ edit_url = page.editions[0].key + '?m=edit'
$elif page.type.key in ["/type/work", "/type/edition", "/type/author"]:
    $ edit_url = page.url(suffix="/edit")
$else:
    $ edit_url = page.key + "?m=edit"

$ viewbook = "//%s/stream/XXX?ref=ol" % bookreader_host()
$ prices = page.key.startswith('/books/')

$ oclc_numbers = (page.oclc_numbers and page.oclc_numbers[0]) or ""
$ isbn_13 = page.get_isbn13()
$ isbn_10 = page.get_isbn10()

$ asin = None
$if page.get('identifiers'):
    $if page.identifiers.get('amazon'):
        $ asin = page.identifiers.amazon[0]

$if isbn_10 and not asin:
    $ asin = isbn_10

<div class="Tools">
  <div id="read">
    $if page.volumes:
      <h3 class="header">
        <span class="icon read"></span>
        <span class="head">Browse</span>
      </h3>
      $for v in page.volumes:
        $if v.ia_id != "-":
          <div class="panel">
            <p><a href="$viewbook.replace('XXX', v.ia_id)">View Volume $v.volume_number</a></p>
          </div>

    <div class="panel">
      <div class="btn-notice read-options" id="read-options">

        <div class="illustration edition-cover">
          $:render_template('covers/book_cover', page)
          $# Don't display add/change cover link for /books/ia:foo00bar pages
          $if not page.is_fake_record():
              $:render_template('covers/change', page, ".edition-cover .bookCover img")
        </div>
        
      <div class="mobile-book-header">
        <div class="work-line">
          $_("An edition of") <a href="$work.key?edition=$(ocaid)">$work_title$cond(work.subtitle, ': %s' % work.subtitle)</a>
          $if work.first_publish_year:
              <span class="first-published-date" title="$_('First published in %s', work.first_publish_year)">
                ($work.first_publish_year)
              </span>
        </div>
  
        $ book_title = edition.get('title', '') or (work.title if work else '')
        $if page.type.key in ["/type/work", "/type/edition", "/type/author"]:
          $if edition and page.type.key in ["/type/work"]:
            $ edit_url = edition.url(suffix="/edit")
          $else:
            $ edit_url = page.url(suffix="/edit")
        $else:
          $ edit_url = page.key + "?m=edit"
        $:render_template("type/edition/compact_title", book_title, edit_url)
        $:render_template("type/edition/book_title", book_title, edition)
  
        $ authors = (work or edition).get_authors()
        $ author_names = (work or edition).author_names
        $if authors:
          <h2 class="edition-byline">
            $:macros.BookByline([(author.name, author.url()) for author in authors], attrs='itemprop="author"')
          </h2>
        $elif author_names:
          <h2 class="edition-byline">
            $:macros.BookByline([(name, None) for name in author_names], attrs='itemprop="author"')
          </h2>
  
        $ component_times['ReadlogStats'] = time()
        $:macros.StarRatingsStats(work)
        $ component_times['ReadlogStats'] = time() - component_times['ReadlogStats']
      </div>

        $ render_times['databarWork: DonateModal'] = time()
        $:macros.DonateModal(page, ids={'isbn': isbn_13, 'asin': asin, 'prices': True})
        $ render_times['databarWork: DonateModal'] = time() - render_times['databarWork: DonateModal']

        $ work = (page.works and page.works[0]) or page
        $ edition = page.works and page

        $ render_times['databarWork: List widget'] = time()
        $ lists_widget = render_template('lists/widget', edition or work, include_rating=True, include_header=False, include_widget=True, include_showcase=False, user_lists_only=False)
        $ render_times['databarWork: List widget'] = time() - render_times['databarWork: List widget']

        $# For the Works & Editions page, only use ground_truth_availability API for selected Edition
        $# if edition availability status is error
        $ render_times['databarWork: LoanStatus'] = time()
        $ expensive_check = page.get('availability', {}).get('status') in ['error']
        $:macros.LoanStatus(page, allow_expensive_availability_check=expensive_check, secondary_action=editions_page, check_sponsorship=editions_page, sponsorship_help=editions_page, check_loan_status=editions_page, post=lists_widget)
        $ render_times['databarWork: LoanStatus'] = time() - render_times['databarWork: LoanStatus']

        $if editions_page:
          $ render_times['databarWork: Book provider'] = time()
          $ book_provider = get_book_provider(page)
          $if book_provider:
            $:book_provider.render_download_options(page)
          $ render_times['databarWork: Book provider'] = time() - render_times['databarWork: Book provider']
      </div>
    </div>

    $ prices = page.key.startswith('/books/')

    $ oclc_numbers = (page.oclc_numbers and page.oclc_numbers[0]) or ""
    $ isbn_13 = page.get_isbn13()
    $ isbn_10 = page.get_isbn10()

    $ asin = None
    $if page.get('identifiers'):
        $if page.identifiers.get('amazon'):
            $ asin = page.identifiers.amazon[0]

    $if isbn_10 and not asin:
        $ asin = isbn_10
    <div class="panel">
      <div class="btn-notice">
        $:macros.WorldcatLink(isbn=isbn_13, oclc_numbers=oclc_numbers, referer=page.url(relative=False))

        <div class="cta-section">
          <p class="cta-section-title">$_('Buy this book')</p>
          $ render_times['databarWork: AffiliateLinks'] = time()
          $:macros.AffiliateLinks(page, {'isbn': isbn_13, 'asin': asin, 'prices': prices})
          $ render_times['databarWork: AffiliateLinks'] = time() - render_times['databarWork: AffiliateLinks']
        </div>
      </div>
    </div>

    <div class="panel list-view">
      <div class="btn-notice">
          $if ctx.get('share_links'):
            $:macros.SocialShare(ctx.get('share_links'), request.home + page.key)
        </div>
    </div>

    $if edition and edition.sponsorship_data:
      <div class="sponsorship-card">
        $if edition.sponsorship_data.donor:
          $ donor = edition.sponsorship_data.donor
          $if edition.sponsorship_data.donor_account:
            $ donor = edition.sponsorship_data.donor_account.render_link()
          $:_('This book was generously donated by %(donor)s', donor=donor)
        $else:
          $_('This book was generously donated anonymously')
        <hr>
        $if edition.sponsorship_data.donor_msg:
          <q>$edition.sponsorship_data.donor_msg</q>
          <hr>
        <a href="/sponsorship" class="learn-more">$_("Learn more about Book Sponsorship")</a>
      </div>
  </div>
</div>
