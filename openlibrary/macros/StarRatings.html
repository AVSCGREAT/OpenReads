$def with (work, edition=None, redir_url=None, rating=None)

$ username = ctx.user and ctx.user.key.split('/')[-1]
$if rating is None and work and username:
  $ rating = work.get_users_rating(username)
$ edition_key = edition.key if edition else ""

<form class="star-rating-form" id="starRatingSection" method="POST" action="$(work.key)/ratings.json"
      property="reviewRating" typeof="Rating" vocab="http://schema.org/">
  <meta property="worstRating" content="1"/>
  <meta property="bestRating" content="5"/>
  <input type="hidden" value="$edition_key" name="edition_id"/>
  <input type="hidden" value="true" name="redir"/>
  $if redir_url:
    $ page = query_param('page', '0')
    $if safeint(page) > 1:
      <input type="hidden" value="$page" name="page"/>
    <input type="hidden" value="$redir_url" name="redir_url"/>
  <div class="stars" data-ol-link-track="StarRating|BookRated">
    $ NUM_STARS = 5
    $for star in range(1, NUM_STARS + 1)
      $ properties = []
      $if star == rating:
        $ properties.append("ratingValue")
      $if star == 1:
        $ properties.append("worstRating")
      $elif (star == NUM_STARS):
        $ properties.append("bestRating")
      <label
        class="star $cond(rating and rating == star, 'star-selected') $cond(rating and star <= rating, 'yellow')"
        $:cond(properties, 'property="' + " ".join(properties) + '"')
        title="$star"
      >
        <input
          type="submit"
          value="$star"
          name="rating"
          class="$cond(rating==star, 'star-selected')"
        >
      </label>
    </div>
  <button type="submit" class="clear-rating $cond(not rating, 'hidden')">$_("Clear my rating")</button>
</form>
