$def with (link_text, id, classes='', work=None, edition=None, notes=None, work_key=None)

$ username = ctx.user and ctx.user.key.split('/')[-1]
$ has_edition = edition is not None
$ edition_notes = None
$if work:
  $ edition_notes = work.get_users_notes(username) if not has_edition else work.get_users_notes(username, edition.key.split('/')[-1])

$if edition_notes is not None and len(edition_notes):
  $ notes = edition_notes.notes

$ book_descriptor = _("work")

$ i18n_strings = {
  $ "close_text": _("Close"),
  $ "submit_text": _("Submit")
  $ }

$if not work_key:
  $ work_key = work.key

$ context = {
  $ "username": username,
  $ "work": work_key,
  $ "id": id
  $ }

$if has_edition:
  $ context["edition"] = edition.key
  $ book_descriptor = _("edition")

<div class="$classes">
  <a class="modal-link" href="javascript:;" data-context="$json_encode(context)" data-i18n="$json_encode(i18n_strings)">$link_text</a>

  <div class="hidden">
    <div id="$id-metadata-form" class="floaterAdd metadata-form">
      <div class="floaterHead">
        <h2>$_("My Book Notes")</h2>
        <a class="dialog--close">&times;<span class="shift">$_("Close")</span></a>
      </div>
      <form class="book-notes-form" method="POST">
        <p>My personal notes about this $book_descriptor:</p>
        <div>
          <textarea name="notes" rows="10">$(notes if notes else "")</textarea>
        </div>
        <input type="hidden" name="work_id" value="$work_key.split('/')[-1]" />
        $if has_edition:
          <input type="hidden" name="edition_id" value="$edition.key.split('/')[-1]" />
        <button class="update-note-button cta-btn" type="button">Save Note</button>
      </form>
      <div class="floaterHead">
        <h2>$_("Observations")</h2>
      </div>
      <p class="observation-instructions">Additional observations about this $book_descriptor. Each section is optional, but highly recommended.  These anonymous observations will be used to populate the "Reader Observations" section of this page.</p>
      <form class="floatform" name="$id-user-metadata" id="$id-user-metadata"></form>
    </div>
  </div>
</div>
